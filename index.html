<script type="text/javascript" src="blobUtils.js"></script>
<button onclick="snapshot()">Snap!</button>
<video id="myVidPlayer" muted autoplay></video>
<div class="mycanvas">
    <h6>Captured snapshot</h6>
    <canvas></canvas>
</div>
<script type="text/javascript">
    const canvas = document.querySelector("canvas");
    const context = canvas.getContext("2d");
    const video = document.querySelector('#myVidPlayer');
    const socket = new WebSocket("wss://api.hume.ai/v0/stream/models?apiKey=IgSfnRwS4whHOTGMhxwxh5m6CGoKMj8zu1RrzwwoaErcjZkY")
    const actx = new AudioContext();
    const gain = new GainNode(actx);
    const oscs = [new OscillatorNode(actx, {type:"sine", frequency:440})];
    gain.connect(actx.destination);

    oscs[0].connect(gain);
    oscs[0].start();

    socket.onopen = e => console.log("Successfully connected to HUME");
    socket.onerror = e => console.error(`Error connecting to HUME api: ${e}`);
    socket.onmessage = e => {
        //console.log(e);
        actx.resume();
        const data = JSON.parse(e.data);
        const emotions = data["face"]["predictions"][0]["emotions"].sort((a,b) => b.score - a.score);
        const topScore = emotions[0].score;
        gain.gain.value = topScore;
        console.log(gain.gain.value);
    }

    //w-width,h-height
    var w, h;
    canvas.style.display = "none";

    //new
    async function snapshot() {
        context.fillRect(0, 0, w, h);
        context.drawImage(video, 0, 0, w, h);
        const snapBlob = await canvasToImageBlob(canvas);
        const blob64 = await blobToBase64(snapBlob);
        const requestData = JSON.stringify({
            data: blob64,
            models: {
                face: {},
            }
        });

        if (socket.readyState === WebSocket.OPEN) {
            socket.send(requestData);
        }
    }

    window.navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
            video.srcObject = stream;
            video.onloadedmetadata = (e) => {
                video.play();

                //new
                w = video.videoWidth;
                h = video.videoHeight

                canvas.width = w;
                canvas.height = h;
            };
        })
        .catch(error => {
            alert('You have to enable the mike and the camera');
        });
</script>